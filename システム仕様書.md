# Pic_cul システム仕様書

## 1. システム概要

### 1.1 プロジェクト名
**Pic_cul** - 店舗メニュー管理システム

### 1.2 目的
SNS風のUI/UXを持つ店舗メニュー管理・表示システム。店舗オーナーが日々のメニューを簡単に投稿・管理でき、顧客がSNSのようにメニューを閲覧できるプラットフォーム。

### 1.3 主要機能
- 管理者（店舗オーナー）によるメニュー管理
- 日間・週間・月間メニューの設定
- CSV一括登録機能
- SNS風のフィード表示
- QRコードによる店舗アクセス

### 1.4 対象ユーザー
- **管理者**: 店舗オーナー・スタッフ
- **一般ユーザー**: 顧客・来店者

---

## 2. 機能仕様

### 2.1 管理者機能（A系）

#### A-1: 管理者ログイン
- **機能**: 店舗IDとパスワードによる認証
- **エンドポイント**: `POST /api/auth/admin/login`
- **入力**:
  - `store_id`: 店舗ID（必須）
  - `password`: パスワード（必須）
- **出力**:
  - `token`: JWT認証トークン
  - `store`: 店舗情報
- **画面**: `/admin/login`

#### A-2: ユーザーアクセス
- **機能**: QRコードまたは店舗IDによるアクセス
- **エンドポイント**: `POST /api/auth/user/access`
- **入力**:
  - `store_id`: 店舗ID（必須）
- **出力**:
  - `store`: 店舗情報
- **画面**: `/user/access`

#### A-3: ダッシュボード
- **機能**: 管理機能へのアクセスハブ
- **画面**: `/admin/dashboard`
- **表示内容**:
  - 店舗情報
  - メニュー管理へのリンク

### 2.2 メニュー管理機能（B系）

#### B-1: 日間メニュー投稿
- **機能**: 写真付きの日間メニューを投稿
- **エンドポイント**: `POST /api/menus/daily`
- **入力**:
  - `name`: メニュー名（必須）
  - `category`: カテゴリー（任意）
  - `price`: 価格（必須、円単位）
  - `image_url`: 画像URL（必須、Base64またはURL）
  - `date`: 日付（任意、デフォルト: 今日）
- **画面**: `/admin/menus/new`
- **特徴**:
  - 画像プレビュー機能
  - Apple風のデザイン

#### B-2: 週間メニュー設定
- **機能**: 1週間分のメニューを設定（テキストのみ）
- **エンドポイント**: 
  - `GET /api/weekly-menus` - 取得
  - `POST /api/weekly-menus` - 作成・更新
  - `PUT /api/weekly-menus/:id` - 更新
  - `DELETE /api/weekly-menus/:id` - 削除
- **入力**:
  - `day_of_week`: 曜日（0-6、必須）
  - `menu_name`: メニュー名（必須）
  - `category`: カテゴリー（任意）
  - `price`: 価格（任意、円単位）
  - `week_start_date`: 週の開始日（月曜日、必須）
- **画面**: 
  - `/admin/menus/weekly` - 一覧・編集
  - `/admin/menus/weekly/new` - 新規登録
  - `/admin/menus/weekly/csv` - CSV一括登録

#### B-3: 月間メニュー設定
- **機能**: 1ヶ月分のメニューを設定（テキストのみ）
- **エンドポイント**: 
  - `GET /api/monthly-menus` - 取得
  - `POST /api/monthly-menus` - 作成
  - `PUT /api/monthly-menus/:id` - 更新
  - `DELETE /api/monthly-menus/:id` - 削除
- **入力**:
  - `menu_name`: メニュー名（必須）
  - `category`: カテゴリー（任意）
  - `price`: 価格（任意、円単位）
  - `month`: 月（1-12、必須）
  - `year`: 年（必須）
- **画面**: 
  - `/admin/menus/monthly` - 一覧・編集
  - `/admin/menus/monthly/new` - 新規登録
  - `/admin/menus/monthly/csv` - CSV一括登録

#### B-4: メニューの編集・削除
- **機能**: 投稿済みメニューの編集・削除
- **エンドポイント**: 
  - `PUT /api/menus/:id` - 更新
  - `DELETE /api/menus/:id` - 削除
- **画面**: `/admin/menus/list`（未実装）

#### B-5: CSV一括登録
- **機能**: CSVファイルによるメニューの一括登録
- **エンドポイント**: 
  - `POST /api/csv-import/weekly` - 週間メニュー
  - `POST /api/csv-import/monthly` - 月間メニュー
- **CSVフォーマット**:
  - **週間**: `曜日,カテゴリー,メニュー名,価格`
  - **月間**: `カテゴリー,メニュー名,価格`
- **機能**:
  - テンプレートダウンロード
  - バリデーション
  - エラーレポート

### 2.3 ユーザー表示機能（C系）

#### C-1: 日間メニュー表示
- **機能**: フィード形式で日間メニューを表示
- **エンドポイント**: `GET /api/menus/daily/:store_id`
- **画面**: `/feed/:storeId`
- **特徴**:
  - SNS風のフィード表示
  - 画像、メニュー名、価格、カテゴリーを表示

#### C-2: 週間メニュー表示
- **機能**: 週間メニューを表示
- **エンドポイント**: `GET /api/weekly-menus/:store_id`
- **画面**: 未実装

#### C-3: 月間メニュー表示
- **機能**: 月間メニューを表示
- **エンドポイント**: `GET /api/monthly-menus/:store_id`
- **画面**: 未実装

#### C-4: 店舗プロフィール表示
- **機能**: 店舗情報の表示
- **エンドポイント**: `GET /api/stores/:store_id`
- **画面**: 未実装

---

## 3. 技術スタック

### 3.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **HTTPクライアント**: Axios
- **QRコード**: html5-qrcode
- **デザインシステム**: Apple Human Interface Guidelines準拠

### 3.2 バックエンド
- **フレームワーク**: Express.js
- **言語**: TypeScript
- **認証**: JWT (jsonwebtoken)
- **パスワードハッシュ**: bcryptjs
- **ファイルアップロード**: Multer
- **CSVパース**: csv-parse（フォールバック実装あり）

### 3.3 データベース
- **開発環境**: SQLite (better-sqlite3)
- **本番環境**: PostgreSQL
- **ORM**: カスタムモデル（pg/better-sqlite3）

### 3.4 ストレージ
- **開発環境**: ローカルファイルシステム
- **本番環境**: AWS S3（設定可能）

### 3.5 開発ツール
- **ビルドツール**: tsx (開発), tsc (本番)
- **パッケージマネージャー**: npm
- **環境変数管理**: dotenv

---

## 4. データベース設計

### 4.1 テーブル一覧

#### stores（店舗テーブル）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | 店舗ID（内部） |
| store_id | VARCHAR(50) | UNIQUE, NOT NULL | 店舗ID（公開用） |
| name | VARCHAR(255) | NOT NULL | 店舗名 |
| password_hash | VARCHAR(255) | NOT NULL | パスワードハッシュ |
| profile_image_url | TEXT | | プロフィール画像URL |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

#### menus（日間メニューテーブル）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | メニューID |
| store_id | VARCHAR(50) | FOREIGN KEY | 店舗ID |
| name | VARCHAR(255) | NOT NULL | メニュー名 |
| category | VARCHAR(100) | | カテゴリー |
| price | INTEGER | NOT NULL | 価格（円） |
| image_url | TEXT | NOT NULL | 画像URL |
| menu_type | VARCHAR(20) | CHECK | メニュータイプ（daily/weekly/monthly） |
| date | DATE | NOT NULL | 日付 |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

#### weekly_menus（週間メニューテーブル）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | メニューID |
| store_id | VARCHAR(50) | FOREIGN KEY | 店舗ID |
| day_of_week | INTEGER | CHECK (0-6) | 曜日（0=日、1=月...） |
| menu_name | VARCHAR(255) | NOT NULL | メニュー名 |
| category | VARCHAR(100) | | カテゴリー |
| price | INTEGER | | 価格（円） |
| week_start_date | DATE | NOT NULL | 週の開始日（月曜日） |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |
| UNIQUE(store_id, day_of_week, week_start_date) | | | 一意制約 |

#### monthly_menus（月間メニューテーブル）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | メニューID |
| store_id | VARCHAR(50) | FOREIGN KEY | 店舗ID |
| menu_name | VARCHAR(255) | NOT NULL | メニュー名 |
| category | VARCHAR(100) | | カテゴリー |
| price | INTEGER | | 価格（円） |
| month | INTEGER | CHECK (1-12) | 月 |
| year | INTEGER | NOT NULL | 年 |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |
| UNIQUE(store_id, month, year, menu_name) | | | 一意制約 |

#### user_accesses（ユーザーアクセスログテーブル）
| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | アクセスID |
| store_id | VARCHAR(50) | FOREIGN KEY | 店舗ID |
| accessed_at | TIMESTAMP | DEFAULT NOW() | アクセス日時 |

### 4.2 インデックス
- `idx_menus_store_date`: menus(store_id, date)
- `idx_menus_store_type`: menus(store_id, menu_type)
- `idx_weekly_menus_store_week`: weekly_menus(store_id, week_start_date)
- `idx_monthly_menus_store_month`: monthly_menus(store_id, year, month)
- `idx_user_accesses_store`: user_accesses(store_id, accessed_at)

---

## 5. API仕様

### 5.1 認証API

#### POST /api/auth/admin/login
管理者ログイン

**リクエスト**:
```json
{
  "store_id": "sample-store-001",
  "password": "password123"
}
```

**レスポンス**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "store": {
    "id": "uuid",
    "store_id": "sample-store-001",
    "name": "サンプル店舗",
    "profile_image_url": null
  }
}
```

#### POST /api/auth/user/access
ユーザーアクセス

**リクエスト**:
```json
{
  "store_id": "sample-store-001"
}
```

**レスポンス**:
```json
{
  "store": {
    "id": "uuid",
    "store_id": "sample-store-001",
    "name": "サンプル店舗",
    "profile_image_url": null
  }
}
```

### 5.2 メニューAPI

#### POST /api/menus/daily
日間メニュー投稿

**認証**: 必須（Bearer Token）

**リクエスト**:
```json
{
  "name": "本日のランチセット",
  "category": "ランチ",
  "price": 1200,
  "image_url": "data:image/jpeg;base64,...",
  "date": "2025-11-13T00:00:00.000Z"
}
```

#### GET /api/menus/daily/:store_id
日間メニュー取得

**クエリパラメータ**:
- `date`: 日付（ISO形式、デフォルト: 今日）

#### POST /api/weekly-menus
週間メニュー作成・更新

**認証**: 必須

**リクエスト**:
```json
{
  "day_of_week": 1,
  "menu_name": "本日のランチセット",
  "category": "ランチ",
  "price": 1200,
  "week_start_date": "2025-11-10"
}
```

#### POST /api/monthly-menus
月間メニュー作成

**認証**: 必須

**リクエスト**:
```json
{
  "menu_name": "本日のランチセット",
  "category": "ランチ",
  "price": 1200,
  "month": 11,
  "year": 2025
}
```

### 5.3 CSVインポートAPI

#### POST /api/csv-import/weekly
週間メニューCSVインポート

**認証**: 必須

**リクエスト**: multipart/form-data
- `file`: CSVファイル
- `week_start_date`: 週の開始日

**レスポンス**:
```json
{
  "success": 5,
  "errors": 1,
  "results": [...],
  "errors": ["行3: エラーメッセージ"]
}
```

#### POST /api/csv-import/monthly
月間メニューCSVインポート

**認証**: 必須

**リクエスト**: multipart/form-data
- `file`: CSVファイル
- `year`: 年
- `month`: 月

---

## 6. UI/UX仕様

### 6.1 デザインシステム
- **デザインガイドライン**: Apple Human Interface Guidelines準拠
- **カラーパレット**:
  - プライマリ: `#007AFF` (Apple Blue)
  - セカンダリ: `#34C759` (Green), `#FF9500` (Orange), `#5856D6` (Purple)
  - グレー: `#8E8E93`, `#C6C6C8`, `#F2F2F7`, `#1C1C1E`
- **タイポグラフィ**: -apple-system, BlinkMacSystemFont
- **アニメーション**: fadeIn, slideUp（0.3-0.4秒）

### 6.2 コンポーネント

#### ボタン
- **プライマリ**: `apple-button-primary` - 青背景、白文字
- **セカンダリ**: `apple-button-secondary` - 白背景、青文字、青枠
- **ホバーエフェクト**: scale-95, 色変化

#### カード
- **ベース**: `apple-card` - 白背景、角丸、影
- **ホバー**: shadow-md

#### 入力フィールド
- **ベース**: `apple-input` - 白背景、角丸、フォーカスリング
- **フォーカス**: 青いリング（#007AFF）

### 6.3 画面一覧

#### 管理者画面
- `/admin/login` - ログイン
- `/admin/dashboard` - ダッシュボード
- `/admin/menus/new` - 日間メニュー投稿
- `/admin/menus/weekly` - 週間メニュー一覧
- `/admin/menus/weekly/new` - 週間メニュー登録
- `/admin/menus/weekly/csv` - 週間メニューCSV登録
- `/admin/menus/monthly` - 月間メニュー一覧
- `/admin/menus/monthly/new` - 月間メニュー登録
- `/admin/menus/monthly/csv` - 月間メニューCSV登録

#### ユーザー画面
- `/user/access` - 店舗アクセス
- `/feed/:storeId` - メニューフィード

---

## 7. セキュリティ

### 7.1 認証・認可
- **管理者認証**: JWT（24時間有効）
- **パスワード**: bcryptjsでハッシュ化（salt rounds: 10）
- **トークン**: localStorageに保存

### 7.2 データ保護
- **パスワード**: 平文保存なし
- **SQLインジェクション対策**: パラメータ化クエリ
- **CORS**: 設定済み

### 7.3 環境変数
- `JWT_SECRET`: JWT署名キー
- `DATABASE_URL`: データベース接続文字列
- `STORAGE_TYPE`: ストレージタイプ（local/s3）
- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`: S3認証情報

---

## 8. 環境設定

### 8.1 開発環境
- **データベース**: SQLite
- **ストレージ**: ローカルファイルシステム
- **ポート**: 
  - フロントエンド: 3000
  - バックエンド: 3001

### 8.2 本番環境
- **データベース**: PostgreSQL
- **ストレージ**: AWS S3
- **環境変数**: 本番用に設定

### 8.3 環境変数設定

#### フロントエンド (.env.local)
```env
NEXT_PUBLIC_API_URL=http://localhost:3001
```

#### バックエンド (.env)
```env
DB_TYPE=postgres
DATABASE_URL=postgresql://user:password@localhost:5432/pic_cul
STORAGE_TYPE=local
PORT=3001
JWT_SECRET=your-secret-key
NODE_ENV=development
```

---

## 9. デプロイメント

### 9.1 ビルド
```bash
# フロントエンド
cd frontend
npm run build

# バックエンド
cd backend
npm run build
```

### 9.2 データベースマイグレーション
```bash
cd backend
npm run db:migrate:prod
npm run db:seed:prod
```

### 9.3 起動
```bash
# フロントエンド
cd frontend
npm start

# バックエンド
cd backend
npm start
```

---

## 10. 運用・保守

### 10.1 ログ
- バックエンド: console.log/console.error
- エラーハンドリング: 統一されたエラーレスポンス

### 10.2 バックアップ
- データベース: PostgreSQLのバックアップ推奨
- 画像: S3のバージョニング推奨

### 10.3 監視
- ヘルスチェック: `GET /health`
- エラーログの監視推奨

---

## 11. 今後の拡張予定

### 11.1 未実装機能
- メニュー一覧・編集ページ（B-4）
- 週間・月間メニュー表示（C-2, C-3）
- 店舗プロフィール表示・編集（C-4）
- メニュー検索機能（C-5）
- パスワードリセット機能（A-3）

### 11.2 改善案
- 画像の最適化（リサイズ、圧縮）
- ページネーション
- キャッシュ機能
- リアルタイム更新（WebSocket）
- 多言語対応

---

## 12. トラブルシューティング

### 12.1 よくある問題

#### データベース接続エラー
- PostgreSQLサービスが起動しているか確認
- 接続文字列が正しいか確認

#### 画像アップロードエラー
- ファイルサイズ制限を確認
- ストレージ設定を確認

#### CSVインポートエラー
- CSVフォーマットが正しいか確認
- エンコーディングがUTF-8か確認

---

## 13. 参考資料

- [README.md](./README.md) - プロジェクト概要
- [開発環境ログイン情報.md](./開発環境ログイン情報.md) - ログイン情報
- [CSV一括登録機能.md](./CSV一括登録機能.md) - CSV機能詳細

---

## 14. ブラッシュアップ・追加構築計画

詳細は [ブラッシュアップ・追加構築計画書.md](./ブラッシュアップ・追加構築計画書.md) を参照してください。

### 14.1 必須ブラッシュアップ
1. セキュリティ強化（JWT Cookie化）
2. UX/画像処理改善（multipart/form-data）
3. パスワードリセット機能
4. 週間/月間メニューに画像追加

### 14.2 新規追加機能
1. いいね/コメント機能
2. ハッシュタグ検索
3. 簡易アクセス解析
4. イチオシメニュー固定

### 14.3 データ構造変更
- 週間・月間メニューテーブルを`menus`テーブルに統合
- `menu_reactions`、`menu_tags`テーブルの追加

---

**最終更新**: 2025年11月13日  
**バージョン**: 1.0.0（現行） / 2.0.0（計画中）

